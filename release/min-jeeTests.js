(function(){var t={},n=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this);var t=function(){!function(t){t.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isFunction=function(t){return"[object Function]"==Object.prototype.toString.call(t)},t.isObject=function(t){return t===Object(t)}}(this),function(t){t._cursorAction=function(t,n,e){var r,i=_promise(),o=this._db.transaction(this._table,t),a=o.objectStore(this._table);if(n){var s,c;for(var u in n)n.hasOwnProperty(u)&&(c=u,s=IDBKeyRange.only(n[u]));if(!c)return void i.reject("invalid index key");var f=a.index(c);r=f.openCursor(s)}else r=a.openCursor();return o.oncomplete=function(){i.resolve(!0)},r.onerror=function(t){console.log(t)},r.onsuccess=function(t){var n=t.target.result;n&&(e(n),n.continue())},i},t.addRows=function(t){var n=_promise(),e=this._db.transaction([this._table],"readwrite");e.oncomplete=function(){n.resolve(!0)},e.onerror=function(t){n.reject(t)};var r=e.objectStore(this._table);for(var i in t){var o=r.add(t[i]);o.onsuccess=function(){}}return n},t.clear=function(){var t=_promise(),n=this._db.transaction(this._table,"readwrite"),e=n.objectStore(this._table),r=e.clear();return r.onerror=function(n){t.fail(n.target.errorCode)},r.onsuccess=function(){t.resolve(!0)},t},t.count=function(){var t=_promise(),n=this._db.transaction([this._table],"readonly");return n.objectStore(this._table).count().onsuccess=function(n){t.resolve(n.target.result)},t},t.forEach=function(t,n){return this._cursorAction("readonly",n,function(n){t(n.value,n)})},t.get=function(t){var n=_promise(),e=this._db.transaction(this._table,"readonly"),r=e.objectStore(this._table),i=r.get(t);return i.onerror=function(e){console.log("Could not get ",t),n.fail(e.target.errorCode)},i.onsuccess=function(){n.resolve(i.result)},n},t.getAll=function(t){var n=[],e=this;return _promise(function(r,i){e._cursorAction("readonly",t,function(t){n.push(t.value)}).then(function(){r(n)}).fail(i)})},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){this._db=t,this._table=n}),t.readAndDelete=function(t){var n=[],e=this;return _promise(function(r,i){e._cursorAction("readwrite",t,function(t){n.push(t.value),t.delete()}).then(function(){r(n)}).fail(i)})},t.remove=function(t){var n=this;return _promise(function(e,r){n._cursorAction("readwrite",t,function(t){t.delete()}).then(function(){e(!0)}).fail(r)})},t.update=function(t,n){var e=_promise(),r=this,i=this._db.transaction([this._table],"readwrite"),o=i.objectStore(this._table);try{var a=o.get(t);a.onerror=function(t){return a.result?void e.fail(t.target.errorCode):void r.addRows([n]).then(function(){e.resolve(n)})},a.onsuccess=function(){if(!a.result)return void r.addRows([n]).then(function(){e.resolve(n)});var t=o.put(n);t.onerror=function(){e.fail("update failed ")},t.onsuccess=function(){e.resolve(n)}}}catch(s){return this.addRows([n])}return e}}(this)},n=function(t,e,r,i,o,a,s,c){var u,f=this;if(!(f instanceof n))return new n(t,e,r,i,o,a,s,c);var l=[t,e,r,i,o,a,s,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){u=t.apply(f,l)}),"function"==typeof u){if(u._classInfo.name!=n._classInfo.name)return new u(t,e,r,i,o,a,s,c)}else if(u)return u;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,l)}):"function"==typeof f.init&&f.init.apply(f,l)};n._classInfo={name:"dbTable"},n.prototype=new t,function(t){var r,i,o;t._initDB=function(){o||(o=window.indexedDB,r=!0,i=e("sys.db",{tables:{databases:{createOptions:{keyPath:"name"}}}}))},t.clearDatabases=function(t){i.then(function(){var n=i.table("databases");n.forEach(function(n,e){t(n)&&(o.deleteDatabase(n.name),e.delete())})})},t.getDB=function(){return this._db},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(t,n){if(!this._db&&(this._initDB(),t)){var e=this,r=o.open(t,4);r.onerror=function(t){console.error(t.target.errorCode)},r.onsuccess=function(n){i.then(function(){var n=i.table("databases");n.addRows([{name:t}])}),e._db=n.target.result,e.resolve(!0)},r.onupgradeneeded=function(t){var r=t.target.result;if(e._db=r,n&&n.tables)for(var i in n.tables)if(n.tables.hasOwnProperty(i)){var o=n.tables[i],a=r.createObjectStore(i,o.createOptions);if(o.indexes)for(var s in o.indexes)if(o.indexes.hasOwnProperty(s)){var c=o.indexes[s];a.createIndex(s,s,c)}}}}}),t.table=function(t){return n(this._db,t)}}(this)},e=function(t,n,r,i,o,a,s,c){var u,f=this;if(!(f instanceof e))return new e(t,n,r,i,o,a,s,c);var l=[t,n,r,i,o,a,s,c];if(f.__factoryClass)if(f.__factoryClass.forEach(function(t){u=t.apply(f,l)}),"function"==typeof u){if(u._classInfo.name!=e._classInfo.name)return new u(t,n,r,i,o,a,s,c)}else if(u)return u;f.__traitInit?f.__traitInit.forEach(function(t){t.apply(f,l)}):"function"==typeof f.init&&f.init.apply(f,l)};e._classInfo={name:"_localDB"},e.prototype=new n,"undefined"!=typeof define&&null!==define&&null!=define.amd&&define(t)}).call(new Function("return this")());